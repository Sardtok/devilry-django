{% extends "trix/base.django.html" %}
{% load extjs %}
{% load i18n %}

{% block title %}{% trans "Exercises" %}{% endblock %}

{% block nav-class %}trix{% endblock %}

{% block headextra %}
  <link rel="stylesheet" media="print"
        href="{{ DEVILRY_STATIC_URL }}/trix/print.css" />
  <script type="text/javascript">
    toggleExc = function(link) {
      elem = link;
      while (elem && elem.getAttribute("class") != "exctext") {
        do {
            elem = elem.nextSibling;
        } while (elem.nodeType !== 1);
      }

      if (elem) {
        if (elem.style.display == 'none') {
          elem.style.display = 'block';
          link.innerHTML = "{% trans "Hide exercise" %}";
        } else {
          elem.style.display = 'none';
          link.innerHTML = "{% trans "Show exercise" %}";
        }
      }
    }
  </script>
  <script src="{{DEVILRY_STATIC_URL}}/trix/setstatus.js"></script>
  <script src="{{DEVILRY_STATIC_URL}}/extjstrix/statisticsmodels.js"></script>

  <script type="text/javascript">
    // Models
    {{ RestfulSimplifiedPeriod|extjs_model }};
    {% comment %}
    {{ RestfulSimplifiedTopic|extjs_model }};
    {{ RestfulSimplifiedExercise|extjs_model }};
    {{ RestfulSimplifiedPeriodExercise|extjs_model }};
    {{ RestfulSimplifiedStatus|extjs_model }};
    {{ RestfulSimplifiedExerciseStatus|extjs_model }};
    {% endcomment %}

    // Test extjs_store
    {{ RestfulSimplifiedPeriod|extjs_store }};
    {% comment %}
    {{ RestfulSimplifiedTopic|extjs_store }};
    {{ RestfulSimplifiedStatus|extjs_store }};
    {{ RestfulSimplifiedExercise|extjs_store }};
    {{ RestfulSimplifiedPeriodExercise|extjs_store }};
    {{ RestfulSimplifiedExerciseStatus|extjs_store }};
    {% endcomment %}
  </script>
{% endblock %}

{% block main %}
{% if user.is_authenticated %}
  <div class="levelinfo">
    {% include "trix/xpbar.django.html" %}
    <div>{% trans "Total points" %}:
      <span id="total_points">{{ level.total_points }}</span>
    </div>
  </div>
{% endif %}

{% if topics %}
<div class="topics">{% trans "Topics" %}:
  {% for id, topic in topics.items %}
  {{ topic.name }}
  {% endfor %}
</div>
{% endif %}

{% if prerequisites %}
<div class="topics">{% trans "Prerequisites" %}:
  {% for prerequisite in prerequisites.values %}
  {{ prerequisite.name }}

  {% endfor %}</div>
{% endif %}

<div id="perioddropdown"></div>

{% for p, p_excs in exercises.items %}
  <form autocomplete="off">
  <table class="exercises">
    <caption>{% trans "Exercises" %} —
      {{ p.parentnode.long_name }} —
      {{ p.long_name }}</caption>
    <thead>
      <tr>
        <th
           {% if statuses %}class="maincol"{% endif %}
           >{% trans "Exercise" %}</th>
        {% if statuses %}
          {% for status in statuses %}
            <th class="statusbutton">{{ status.name }}</th>
          {% endfor %}
          <th class="statusbutton">{% trans "Unsolved" %}</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
        
      {% for id, e in p_excs.items %}
      <tr>
        <td
           {% if statuses %}class="maincol"{% endif %}
           >
          {% if statuses %}
          <a class="dispexc" href="javascript:void(0)"
             onClick="toggleExc(this)" style="float: right;">
            {% if e.status == -1 %}
              {% trans "Hide exercise" %}
            {% else %}
              {% trans "Show exercise" %}
            {% endif %}
          </a>
          {% endif %}
          <h3>{% if e.starred %}
            <img src="{{DEVILRY_STATIC_URL}}/trix/icons/star.png" />
            {% endif %}
            {{ e.title }}</h3>
          {% autoescape off %}
          <div class="exctext"
               {% if statuses and e.status != -1 %}style="display: none"{% endif %}
               >{{ e.text }}</div>
          {% endautoescape %}
        </td>
        {% if statuses %}
          {% for status in statuses %}
            <td class="statusbutton">
              <input type="radio" name="{{ id }}" value="{{ status.id }}"
                     {% if e.status == status.id %}
                     checked="checked"
                     {% endif %}
                     onChange="setStatus(this.name, this.value)"/>
            </td>
          {% endfor %}
          <td class="statusbutton">
            <input type="radio" name="{{ id }}" value="-1"
                     {% if e.status == -1 %}
                     checked="checked"
                     {% endif %}
                     onChange="setStatus(this.name, this.value)"/>
          </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </form>
{% endfor %}

  <script type="text/javascript">
    Ext.create('devilry.extjshelpers.formfields.ForeignKeySelector', {
      fieldLabel: '{% trans "View period" %}',
      model: {{ RestfulSimplifiedPeriod|extjs_modelname }},
      renderTo: 'perioddropdown',
      displayTpl: '{long_name}',
      dropdownTpl: '{long_name}',
      setRecordValue: function(record) {
        document.location.href=("/trix/period/" + record.data.id);
      }
    });
  </script>
{% endblock %}
