{% extends "examiner/base.django.html" %}
{% load extjs %}


{% block headextra %}

<script>

    {% for RestfulCls in restfulclasses %}
        {{ RestfulCls|extjs_combobox_model }}
    {% endfor %}

    var DASHBOARD_URL = '{{ DEVILRY_MAIN_PAGE }}/examiner/';
    var assignmentstore = {{ RestfulSimplifiedAssignment|extjs_store }}
    var assignmentgroupstore = {{ RestfulSimplifiedAssignmentGroup|extjs_store }}
    var deliverystore = {{ RestfulSimplifiedDelivery|extjs_store }}

    Ext.require('devilry.extjshelpers.searchwidget.SearchWidget');
    Ext.require('devilry.extjshelpers.searchwidget.FilterConfigDefaults');
    Ext.onReady(function() {
        var searchwidget = Ext.create('devilry.extjshelpers.searchwidget.SearchWidget', {
            renderTo: 'searchwidget',
            searchResultItems: [{
                xtype: 'searchresults',
                title: 'Deliveries',
                store: deliverystore,
                filterconfig: devilry.extjshelpers.searchwidget.FilterConfigDefaults.delivery,
                resultitemConfig: {
                    tpl: '{{ RestfulSimplifiedDelivery.ExtjsModelMeta.combobox_tpl|escapejs }}',
                    defaultbutton: {
                        text: 'View',
                        clickLinkTpl: 'assignmentgroup/{deadline__assignment_group}?deliveryid={id}'
                    }
                }
            }, {
                xtype: 'searchresults',
                title: 'Assignment groups',
                store: assignmentgroupstore,
                filterconfig: devilry.extjshelpers.searchwidget.FilterConfigDefaults.assignmentgroup,
                resultitemConfig: {
                    tpl: '{{ RestfulSimplifiedAssignmentGroup.ExtjsModelMeta.combobox_tpl|escapejs }}',
                    defaultbutton: {
                        text: 'View/edit',
                        clickLinkTpl: 'assignmentgroup/{id}'
                    },
                    menuitems: [{
                        text: 'Show deliveries',
                        clickFilter: 'type:delivery group:{id}'
                    }]
                }
            }, {
                xtype: 'searchresults',
                title: 'Assignments',
                store: assignmentstore,
                filterconfig: devilry.extjshelpers.searchwidget.FilterConfigDefaults.assignment,
                resultitemConfig: {
                    tpl: '{{ RestfulSimplifiedAssignment.ExtjsModelMeta.combobox_tpl|escapejs }}',
                    defaultbutton: {
                        text: 'Show groups',
                        clickFilter: 'type:group assignment:{id}'
                    },
                    menuitems: [{
                        text: 'Show deliveries',
                        clickFilter: 'type:delivery assignment:{id}'
                    }]
                }
            }]
        });
        searchwidget.loadInitialValues();
        searchwidget.focusOnSearchfield();
        
        var dashboard_assignment_model = {{ RestfulSimplifiedAssignment|extjs_model:"subject,period" }}
        
        var dashboard_assignment_store = Ext.create('Ext.data.Store', {
            model: dashboard_assignment_model,
            groupField: 'parentnode__parentnode__long_name',
            remoteFilter: true,
            remoteSort: true,
            autoSync: true
        });

        //dashboard_assignment_store.proxy.extraParams.result_fieldgroups = Ext.JSON.encode(["subject"]);
        
        dashboard_assignment_store.load();        
        
        var groupingFeature = Ext.create('Ext.grid.feature.Grouping',{
            groupHeaderTpl: '{name}'
        });
        
        var rowTpl = Ext.create('Ext.XTemplate',
            '{.:date}'
        );
        
        var listView = Ext.create('Ext.grid.Panel', {
            collapsible:true,
            title:'Default',
            renderTo: 'content-heading',
            store: dashboard_assignment_store,
            features: [groupingFeature],
            columns: [{
                text: 'Assignment',
                flex: 30,
                dataIndex: 'long_name'
            },{
                text: 'Period',
                dataIndex: 'parentnode__long_name',
                flex: 20
            },{
                text: 'Published',
                flex: 15,
                dataIndex: 'publishing_time',
                renderer: function(value) {
                    return rowTpl.apply(value);
                }
            }],
            listeners: {
                scope: this,
                itemmouseup: function(view, record) {
                    var url = DASHBOARD_URL + "assignment/" + record.data.id
                    window.location = url;
                }
            }
        });
        
        
        
        
        
        
    });


</script>

{% endblock %}


{% block main %}
<div id='searchwidget'></div>
<p class='searchwidget-help'>In the box above, you can search for anything
related to anything that you have permission to view or edit as an
<strong>examiner</strong>. Searching for a user will find any item related to
that user, and searching for a subject will find anything related to that
subject.</p>
<section class="treeheading" id="content-heading"></section>
{% endblock %}
